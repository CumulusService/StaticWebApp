@page "/"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject NavigationManager NavigationManager
@implements IDisposable

<PageTitle>File Upload</PageTitle>

<div class="upload-container">
  <div class="upload-card">
    @if (isUploadComplete)
    {
      <!-- Only show status message after successful upload -->
      <div class="upload-header">
        <div class="logo-container">
          <img src="data:image/png;base64,YOUR_LOGO_BASE64_HERE" class="company-logo" alt="Company Logo" />
        </div>
      </div>
      
      <div class="final-status">
        <div class="status-message @GetStatusClass()">
          <div class="status-icon">
            @if (Status.Contains("✅"))
            {
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12" />
              </svg>
            }
            else if (Status.Contains("❌"))
            {
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="15" y1="9" x2="9" y2="15" />
                <line x1="9" y1="9" x2="15" y2="15" />
              </svg>
            }
          </div>
          <span>@Status.Trim('✅','❌').Trim()</span>
        </div>
      </div>
    }
    else
    {
      <!-- Show upload interface before completion -->
      <div class="upload-header">
        <div class="logo-container">
           <img src="data:image/png;base64,YOUR_LOGO_BASE64_HERE" class="company-logo" alt="Company Logo" />
        </div>
        <h1 class="upload-title">Upload Your File</h1>
        @if (!string.IsNullOrEmpty(Email))
        {
          <div class="user-info">
            <span class="user-icon">👤</span>
            <span class="user-email">@Email</span>
          </div>
        }
      </div>

      <div class="upload-zone">
        <InputFile OnChange="OnFileSelected"
                   accept="*/*"
                   style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;" />

        @if (selectedFile is null)
        {
          <div class="upload-placeholder">
            <div class="upload-icon-large">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="12" y1="18" x2="12" y2="12" />
                <polyline points="9 15 12 12 15 15" />
              </svg>
            </div>
            <h3>Drop your file here or click to browse</h3>
            <p>Supports files up to 10 MB</p>
          </div>
        }
        else
        {
          <div class="file-preview">
            <div class="file-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                <polyline points="14 2 14 8 20 8" />
              </svg>
            </div>
            <div class="file-info">
              <div class="file-name">@selectedFile.Name</div>
              <div class="file-size">@FormatFileSize(selectedFile.Size)</div>
            </div>
            <button class="remove-file" @onclick="RemoveFile">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
              </svg>
            </button>
          </div>
        }
      </div>

      <div class="upload-actions">
        <button class="upload-btn @(CanUpload ? "enabled" : "disabled")"
                @onclick="SubmitFile"
                disabled="@(!CanUpload)">
          @if (isUploading)
          {
            <div class="spinner"></div>
            <span>Uploading…</span>
          }
          else
          {
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            <span>Upload File</span>
          }
        </button>
      </div>

      @if (!string.IsNullOrEmpty(Status) && !isUploadComplete)
      {
        <div class="status-message @GetStatusClass()">
          <div class="status-icon">
            @if (Status.Contains("✅"))
            {
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12" />
              </svg>
            }
            else if (Status.Contains("❌"))
            {
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="15" y1="9" x2="9" y2="15" />
                <line x1="9" y1="9" x2="15" y2="15" />
              </svg>
            }
            else
            {
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="8" x2="12" y2="12" />
                <line x1="12" y1="16" x2="12.01" y2="16" />
              </svg>
            }
          </div>
          <span>@Status.Trim('✅','❌').Trim()</span>
        </div>
      }
    }
  </div>
</div>

<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }
  .upload-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .upload-card {
    background: white;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    padding: 40px;
    width: 100%;
    max-width: 500px;
    animation: slideUp 0.6s ease-out;
  }
  @@keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .upload-header { text-align: center; margin-bottom: 32px; }
  .logo-container { display: flex; justify-content: center; margin-bottom: 16px; }
  .company-logo { height: 80px; width: auto; max-width: 300px; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .upload-title { font-size: 28px; font-weight: 700; color: #1a1a1a; margin: 0 0 16px; }
  .user-info { display:inline-flex;align-items:center;gap:8px;background:#f8f9fa;padding:8px 16px;border-radius:12px;color:#6b7280;font-size:14px; }
  .upload-zone {
    position: relative;
    border: 2px dashed #e5e7eb;
    border-radius: 16px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 24px;
    min-height: 200px;
    display: flex; align-items: center; justify-content: center;
  }
  .upload-zone:hover { border-color: #667eea; background: #f8faff; }
  .upload-placeholder h3 { font-size:18px; font-weight:600; color:#374151; margin:16px 0 8px; }
  .upload-placeholder p { color:#9ca3af; margin:0; font-size:14px; }
  .upload-icon-large { color:#9ca3af; margin-bottom:8px; }
  .file-preview { display:flex; align-items:center; gap:16px; background:#f8f9fa; padding:16px; border-radius:12px; width:100%; }
  .file-icon { color:#667eea; flex-shrink:0; }
  .file-info { flex:1; text-align:left; }
  .file-name { font-weight:600; color:#374151; font-size:14px; margin-bottom:4px; }
  .file-size { color:#9ca3af; font-size:12px; }
  .remove-file { background:#fee2e2; border:none; border-radius:8px; padding:8px; cursor:pointer; color:#dc2626; transition:all 0.2s ease; }
  .remove-file:hover { background:#fecaca; }
  .upload-actions { margin-bottom:24px; }
  .upload-btn {
    width:100%; background:linear-gradient(135deg,#667eea,#764ba2); color:white;
    border:none; border-radius:12px; padding:16px 24px; font-size:16px; font-weight:600;
    cursor:pointer; transition:all 0.3s ease; display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .upload-btn.enabled:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(102,126,234,0.3); }
  .upload-btn.disabled { background:#e5e7eb; color:#9ca3af; cursor:not-allowed; transform:none; box-shadow:none; }
  .spinner {
    width:20px; height:20px; border:2px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:white;
    animation: spin 1s ease-in-out infinite;
  }
  @@keyframes spin {
    to { transform: rotate(360deg); }
  }
  .status-message { display:flex; align-items:center; gap:12px; padding:16px; border-radius:12px; font-weight:500; animation: fadeIn 0.3s ease-out; }
  @@keyframes fadeIn {
    from { opacity:0; transform:translateY(10px); }
    to   { opacity:1; transform:translateY(0); }
  }
  .status-message.success { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
  .status-message.error   { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
  .status-message.info    { background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; }
  
  /* Final state styles */
  .final-status {
    text-align: center;
    padding: 40px 0;
  }
  .final-status .status-message {
    font-size: 18px;
    font-weight: 600;
    justify-content: center;
    padding: 24px;
    margin: 0 auto;
    max-width: 400px;
  }
  .final-status .status-icon svg {
    width: 24px;
    height: 24px;
  }
  
  @@media (max-width: 640px) {
    .upload-card { margin:20px; padding:24px; }
    .upload-title { font-size:24px; }
    .upload-zone  { padding:24px 16px; min-height:160px; }
    .final-status { padding: 20px 0; }
    .final-status .status-message { font-size: 16px; padding: 20px; }
  }
</style>

@code {
  private string Email = string.Empty;
  private string Token = string.Empty;
  private IBrowserFile? selectedFile;
  private bool isUploading;
  private bool isUploadComplete;
  private string Status = string.Empty;

  private bool CanUpload => selectedFile != null && !isUploading && !isUploadComplete;

  protected override void OnInitialized()
  {
    // Enhanced token parsing - supports both query parameters and fragments
    var uri = new Uri(NavigationManager.Uri);
    
    // Parse query parameters (?email=...&token=...)
    var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
    Email = queryParams["email"] ?? "";
    Token = queryParams["token"] ?? "";

    // Also check URL fragments (#token=...) for additional token sources
    if (!string.IsNullOrEmpty(uri.Fragment) && string.IsNullOrEmpty(Token))
    {
      var fragmentParams = uri.Fragment
                              .TrimStart('#')
                              .Split('&', StringSplitOptions.RemoveEmptyEntries)
                              .Select(p => p.Split('=', 2))
                              .Where(kv => kv.Length == 2)
                              .ToDictionary(
                                kv => Uri.UnescapeDataString(kv[0]),
                                kv => Uri.UnescapeDataString(kv[1])
                              );

      if (fragmentParams.ContainsKey("token"))
        Token = fragmentParams["token"];
      
      if (fragmentParams.ContainsKey("email") && string.IsNullOrEmpty(Email))
        Email = fragmentParams["email"];
    }
  }

  private void OnFileSelected(InputFileChangeEventArgs e)
  {
    if (!isUploadComplete)
    {
      selectedFile = e.File;
      Status = string.Empty;
    }
  }

  private Task RemoveFile()
  {
    if (!isUploadComplete)
    {
      selectedFile = null;
      Status = string.Empty;
    }
    return Task.CompletedTask;
  }

  private string FormatFileSize(long bytes)
  {
    string[] sizes = { "B", "KB", "MB", "GB" };
    double size = bytes;
    int order = 0;
    while (size >= 1024 && order < sizes.Length - 1)
    {
      size /= 1024;
      order++;
    }
    return $"{size:0.##} {sizes[order]}";
  }

  private string GetStatusClass() =>
    Status.Contains("✅") ? "success"
  : Status.Contains("❌") ? "error"
  : "info";

  private async Task SubmitFile()
  {
    if (selectedFile == null || isUploadComplete)
    {
      Status = "❌ No file selected";
      return;
    }
    if (selectedFile.Size > 10 * 1024 * 1024)
    {
      Status = "❌ File too large. Maximum size is 10 MB.";
      return;
    }

    isUploading = true;
    Status = "Uploading…";

    try
    {
      using var stream = selectedFile.OpenReadStream(10 * 1024 * 1024);
      using var ms = new MemoryStream();
      await stream.CopyToAsync(ms);
      var bytes = ms.ToArray();

      var content = new MultipartFormDataContent();
      content.Add(new ByteArrayContent(bytes), "file", selectedFile.Name);
      content.Add(new StringContent(Email), "email");
      content.Add(new StringContent(Token), "token");

      var response = await Http.PostAsync("/api/upload", content);
      
      if (response.IsSuccessStatusCode)
      {
        Status = "✅ Upload successful!";
        isUploadComplete = true;
      }
      else
      {
        Status = $"❌ Error: {response.StatusCode}";
      }
    }
    catch (Exception ex)
    {
      Status = $"❌ Error: {ex.Message}";
    }
    finally
    {
      isUploading = false;
    }
  }

  public void Dispose() { }
}